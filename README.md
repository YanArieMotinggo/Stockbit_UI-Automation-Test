# Android UI Automation Test

Automated testing framework for Android apps using Appium, Cucumber, and Maven.

## Prerequisites

- Java 17 or higher
- Maven 3.6+
- Node.js 16+ and npm
- Android SDK with platform-tools
- Android emulator or physical device

## Setup

### 1. Install Android SDK

Ensure Android SDK is installed and the environment variable is set:

```bash
export ANDROID_HOME=/path/to/Android/sdk
export PATH=$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$PATH
```

Add these lines to the shell profile (~/.zshrc or ~/.bashrc) to make them permanent.

### 2. Install Appium

Install Appium and the UiAutomator2 driver locally in the project:

```bash
npm install
```

Or install manually:

```bash
npm install appium@2.5.0
npx appium driver install uiautomator2@2.45.1
```

### 3. Add the APK

Place the Android APK file in the app folder:

```
src/test/resources/app/app.apk
```

Then update the `test.properties` file to point to the APK:

```properties
app=src/test/resources/app/app.apk
```

### 4. Configure Device

Edit `src/test/resources/test.properties` to match the emulator or device:

```properties
# Appium server
appium=http://127.0.0.1:4723

# Device (use 'adb devices' to find the device id)
device=emulator-5554
version=12

# App
app=src/test/resources/app/app.apk

# Timeouts
wait=15
```

## Running Tests

### Step 1: Start the Android Emulator

Start the emulator from Android Studio or via command line:

```bash
emulator -avd AVD_Name
```

Verify the device is connected:

```bash
adb devices
```

### Step 2: Start Appium Server

Open a terminal and start the Appium server:

```bash
export ANDROID_HOME=/path/to/Android/sdk
export PATH=$ANDROID_HOME/platform-tools:$PATH
npx appium --relaxed-security
```

Keep this terminal running while executing tests.

### Step 3: Run Tests

Open another terminal and run:

```bash
# Run all tests
mvn test

# Run specific feature by tag
mvn test -Dcucumber.filter.tags="@generate"
mvn test -Dcucumber.filter.tags="@explore"
mvn test -Dcucumber.filter.tags="@shopping"

# Run generated tests
mvn test -Dcucumber.filter.tags="@generated"
```

## Project Structure

```
src/test/
  java/com/test/
    engine/
      Explorer.java      - App exploration using DFS
      Session.java       - Appium session management
      TestGenerator.java - Generates tests and screen classes
    screens/
      generated/         - Screen classes generated by Explorer
    steps/
      ExplorerSteps.java  - Cucumber steps for exploration
      ShoppingSteps.java  - Cucumber steps for tests
      TestHooks.java      - Before/After hooks
  resources/
    app/
      app.apk            - The Android app
    features/
      Explore.feature    - Manual exploration scenarios
      Shopping.feature   - Manual test scenarios
      GenerateTests.feature - Triggers exploration and test generation
      generated/         - Feature files generated by Explorer
    test.properties      - Configuration
```

## How It Works

### The Exploration Flow

When running `mvn test -Dcucumber.filter.tags="@generate"`, the following happens:

1. The app launches on the emulator or device
2. The Explorer waits for the app to load, then starts on the first screen
3. It scans the current screen and finds all UI elements (buttons, text fields, labels)
4. It scrolls down to find any elements that are off-screen
5. For each clickable element it finds, it does the following:
   - Taps the element
   - Checks if a new screen appeared, or if new elements appeared (like a dropdown menu)
   - If a new screen appeared, it goes into that screen and repeats the process (depth-first)
   - After exploring the new screen, it goes back and continues with the next element
   - If tapping opened a menu or popup, it records those new elements and explores them too
6. The Explorer keeps track of every screen it visits and how it got there
7. If the app crashes or exits, it tries to restart and continue
8. After exploring (or hitting the timeout), it generates test files

The result is a map of the entire app: which screens exist, what elements are on each screen, and how to navigate between them.

### What Gets Generated

After exploration, the framework creates two types of files:

**Feature files** in `src/test/resources/features/generated/`:

- `Navigation.feature` - Test scenarios that verify navigation to each discovered screen. Each test includes the exact sequence of taps needed to reach that screen.
- `Elements.feature` - Test scenarios that tap each discovered button and verify the app does not crash.
- `SmokeGenerated.feature` - A few key test scenarios covering common paths like opening menus and adding items to cart.

**Screen classes** in `src/test/java/com/test/screens/generated/`:

For each screen discovered, a Java class is created with:
- Constants for each element ID found on that screen
- A tap method for each clickable element
- An enter method for each text input field
- A navigateHere method that contains the tap sequence to reach this screen from the app start

Example of a generated screen class:

```java
public class ProductsScreen {
    private static final String MENUIV = "id:menuIV";
    private static final String CARTRL = "id:cartRL";
    private static final String PRODUCTIV = "id:productIV";

    public void tapMenu() {
        app.tap(MENUIV);
    }

    public void tapCart() {
        app.tap(CARTRL);
    }

    public void navigateHere() {
        // empty if this is the starting screen
    }
}
```

### Using the Generated Tests

Once generation is complete, run the generated tests:

```bash
mvn test -Dcucumber.filter.tags="@generated"
```

This runs all the tests that were created from exploration. If any test fails, it means something changed in the app or there is a bug.

The generated screen classes can also be used in custom tests to make them easier to write and maintain.

### Manual Tests

Write test scenarios in `.feature` files:

```gherkin
Feature: Shopping

  Scenario: Add item to cart
    Given the app is running
    When I tap on "productIV"
    And I tap on "cartBt"
    Then I should see "Cart"
```

Available step definitions:

- `Given the app is running` - verifies app is ready
- `When I tap on "elementId"` - taps an element by ID or text
- `When I tap on "elementId" {n} times` - taps multiple times
- `When I enter "text" in "elementId"` - types into a field
- `Then I should see "text"` - verifies text is visible
- `Then I go back` - presses back button

## Troubleshooting

### Appium server not starting

Ensure ANDROID_HOME is set correctly:

```bash
echo $ANDROID_HOME
```

### Device not found

Check if the device/emulator is running:

```bash
adb devices
```

### App not installing

Clear UiAutomator2 cache:

```bash
adb shell pm clear io.appium.uiautomator2.server
adb shell pm clear io.appium.uiautomator2.server.test
```

### Session timeout

Increase timeouts in `test.properties`:

```properties
wait=30
```

Or in `Session.java`, adjust the timeout durations.

## Test Reports

After running tests, find reports in:

- `target/cucumber-report.html` - Cucumber HTML report
- `target/surefire-reports/` - JUnit test reports
