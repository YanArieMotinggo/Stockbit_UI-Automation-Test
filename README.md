# Android UI Automation Test

Automated testing framework for Android apps using Appium, Cucumber, and Maven.

## Prerequisites

- Java 17 or higher
- Maven 3.6+
- Node.js 16+ and npm
- Android SDK with platform-tools (via Android Studio)
- Android emulator or physical device

## Quick Start

### Step 1: Set Up Environment Variables (Recommended - One-Time Setup)

Add these lines to your shell profile (`~/.zshrc` on macOS or `~/.bashrc` on Linux):

```bash
# Android SDK - typical macOS path
export ANDROID_HOME=~/Library/Android/sdk
export PATH=$ANDROID_HOME/platform-tools:$ANDROID_HOME/emulator:$PATH
```

Then reload your shell:

```bash
source ~/.zshrc
```

Verify the setup:

```bash
echo $ANDROID_HOME
# Should print: /Users/your-username/Library/Android/sdk

adb --version
# Should print adb version info
```

> **Note:** If you skip this step, you must include `export ANDROID_HOME=...` in every terminal command (see "Running Tests Without Global Setup" below).

### Step 2: Install Dependencies

```bash
npm install
```

This installs Appium and the UiAutomator2 driver.

### Step 3: Configure Device

Edit `src/test/resources/test.properties`:

```properties
# Appium server
appium=http://127.0.0.1:4723

# Device (use 'adb devices' to find the device id)
device=emulator-5554
version=12

# App
app=src/test/resources/app/mda-1.0.13-15.apk

# Timeouts
wait=15
```

---

## Running Tests (With Global ANDROID_HOME Setup)

If you completed Step 1 above, use these simple commands.

You need **3 terminal windows** open:

### Terminal 1: Start the Android Emulator

```bash
# List available emulators
emulator -list-avds

# Start your emulator (replace with your AVD name)
emulator -avd Pixel_6_Pro_Edited_API_34
```

Verify the device is connected:

```bash
adb devices
# Should show: emulator-5554    device
```

### Terminal 2: Start Appium Server

```bash
npx appium --relaxed-security
```

Wait until you see:

```
[Appium] Appium REST http interface listener started on http://0.0.0.0:4723
```

**Keep this terminal running** while executing tests.

### Terminal 3: Run Tests

```bash
# Run the test generator (explores the app and creates test files)
mvn test -Dcucumber.filter.tags="@generate"

# Run generated tests
mvn test -Dcucumber.filter.tags="@generated"

# Run shopping flow tests
mvn test -Dcucumber.filter.tags="@shopping"

# Run all tests
mvn test
```

---

## Running Tests Without Global Setup (Copy-Paste Commands)

If you **did not** add `ANDROID_HOME` to your `~/.zshrc`, use these commands instead. Each command includes the required environment variables.

### Terminal 1: Start the Android Emulator

```bash
# List available emulators
~/Library/Android/sdk/emulator/emulator -list-avds

# Start your emulator (replace YOUR_AVD_NAME with your emulator name)
~/Library/Android/sdk/emulator/emulator -avd YOUR_AVD_NAME
```

### Terminal 2: Start Appium Server

 **Important:** The Appium server MUST have `ANDROID_HOME` set, or tests will fail with "Neither ANDROID_HOME nor ANDROID_SDK_ROOT environment variable was exported".

```bash
export ANDROID_HOME=~/Library/Android/sdk && export PATH=$ANDROID_HOME/platform-tools:$PATH && npx appium --relaxed-security
```

Wait until you see:

```
[Appium] Appium REST http interface listener started on http://0.0.0.0:4723
```

### Terminal 3: Run Tests

```bash
export ANDROID_HOME=~/Library/Android/sdk && export PATH=$ANDROID_HOME/platform-tools:$PATH && mvn test -Dcucumber.filter.tags="@generate"
```

Other test commands:

```bash
# Run generated tests
export ANDROID_HOME=~/Library/Android/sdk && export PATH=$ANDROID_HOME/platform-tools:$PATH && mvn test -Dcucumber.filter.tags="@generated"

# Run shopping tests
export ANDROID_HOME=~/Library/Android/sdk && export PATH=$ANDROID_HOME/platform-tools:$PATH && mvn test -Dcucumber.filter.tags="@shopping"

# Run all tests
export ANDROID_HOME=~/Library/Android/sdk && export PATH=$ANDROID_HOME/platform-tools:$PATH && mvn test
```

---

## Project Structure

```
src/test/
  java/com/test/
    engine/
      Explorer.java      - App exploration using DFS
      Session.java       - Appium session management
      TestGenerator.java - Generates tests and screen classes
    screens/
      generated/         - Screen classes generated by Explorer
    steps/
      ExplorerSteps.java  - Cucumber steps for exploration
      ShoppingSteps.java  - Cucumber steps for tests
      TestHooks.java      - Before/After hooks
  resources/
    app/
      *.apk              - The Android app
    features/
      Explore.feature    - Manual exploration scenarios
      Shopping.feature   - Manual test scenarios
      GenerateTests.feature - Triggers exploration and test generation
      generated/         - Feature files generated by Explorer
    test.properties      - Configuration
```

## How It Works

### The Exploration Flow

When running `mvn test -Dcucumber.filter.tags="@generate"`, the following happens:

1. The app launches on the emulator or device
2. The Explorer waits for the app to load, then starts on the first screen
3. It scans the current screen and finds all UI elements (buttons, text fields, labels)
4. It scrolls down to find any elements that are off-screen
5. For each clickable element it finds, it does the following:
   - Taps the element
   - Checks if a new screen appeared, or if new elements appeared (like a dropdown menu)
   - If a new screen appeared, it goes into that screen and repeats the process (depth-first)
   - After exploring the new screen, it goes back and continues with the next element
   - If tapping opened a menu or popup, it records those new elements and explores them too
6. The Explorer keeps track of every screen it visits and how it got there
7. If the app crashes or exits, it tries to restart and continue
8. After exploring (or hitting the timeout), it generates test files

The result is a map of the entire app: which screens exist, what elements are on each screen, and how to navigate between them.

### What Gets Generated

After exploration, the framework creates two types of files:

**Feature files** in `src/test/resources/features/generated/`:

- `Navigation.feature` - Test scenarios that verify navigation to each discovered screen
- `Elements.feature` - Test scenarios that tap each discovered button and verify the app does not crash
- `SmokeGenerated.feature` - Key test scenarios covering common paths

**Screen classes** in `src/test/java/com/test/screens/generated/`:

For each screen discovered, a Java class is created with:
- Constants for each element ID found on that screen
- A tap method for each clickable element
- An enter method for each text input field
- A navigateHere method that contains the tap sequence to reach this screen from the app start

### Manual Tests

Write test scenarios in `.feature` files:

```gherkin
Feature: Shopping

  Scenario: Add item to cart
    Given the app is running
    When I tap on "productIV"
    And I tap on "cartBt"
    Then I should see "Cart"
```

Available step definitions:

- `Given the app is running` - verifies app is ready
- `When I tap on "elementId"` - taps an element by ID or text
- `When I tap on "elementId" {n} times` - taps multiple times
- `When I enter "text" in "elementId"` - types into a field
- `Then I should see "text"` - verifies text is visible
- `Then I go back` - presses back button

## Troubleshooting

### "Neither ANDROID_HOME nor ANDROID_SDK_ROOT environment variable was exported"

This is the most common error. It means the **Appium server** was started without `ANDROID_HOME` set.

**Fix:**
1. Stop the Appium server (Ctrl+C)
2. Restart it with ANDROID_HOME:

```bash
export ANDROID_HOME=~/Library/Android/sdk && export PATH=$ANDROID_HOME/platform-tools:$PATH && npx appium --relaxed-security
```

### "Cannot start session" or "Connection refused"

This means the Appium server is not running or not reachable.

**Fix:**
1. Check if Appium is running: `curl http://127.0.0.1:4723/status`
2. If not, start Appium (see Terminal 2 commands above)
3. Make sure Appium shows "listener started on http://0.0.0.0:4723" before running tests

### "command not found: emulator" or "command not found: adb"

Your `ANDROID_HOME` is not in PATH. Use full paths:

```bash
# List emulators
~/Library/Android/sdk/emulator/emulator -list-avds

# Start emulator
~/Library/Android/sdk/emulator/emulator -avd YOUR_AVD_NAME

# Check devices
~/Library/Android/sdk/platform-tools/adb devices
```

Or add to your `~/.zshrc` (recommended).

### Device not found

1. Check if the emulator is running and fully booted
2. Run `adb devices` to verify connection
3. If using a physical device, enable USB debugging

### App not installing

Clear UiAutomator2 cache:

```bash
adb shell pm clear io.appium.uiautomator2.server
adb shell pm clear io.appium.uiautomator2.server.test
```

### Session timeout

Increase timeouts in `test.properties`:

```properties
wait=30
```

## Test Reports

After running tests, find reports in:

- `target/cucumber-report.html` - Cucumber HTML report
- `target/surefire-reports/` - JUnit test reports
